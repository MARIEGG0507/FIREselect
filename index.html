<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菲式選股策略儀表板</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. React & ReactDOM (Core) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 2. Prop-Types (Recharts 依賴) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- 3. Recharts (Charts) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- 4. Babel (JSX Transpiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ComposedChart, Area, AreaChart } = Recharts;

        // --- 內嵌 Icon 元件 (取代不穩定的 lucide-react UMD) ---
        // 這些是標準的 SVG 圖示，確保在任何環境下都能執行
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" stroke="currentColor" 
                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Wifi = (props) => <IconBase {...props}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12" y1="20" y2="20"/></IconBase>;
        const WifiOff = (props) => <IconBase {...props}><line x1="2" x2="22" y1="2" y2="22"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12" y1="20" y2="20"/><path d="M1.42 9a16 16 0 0 1 6 2.6"/><path d="M17 9a16 16 0 0 1 5.58 0"/><path d="M5 12.55a11 11 0 0 1 1.57-1.34"/></IconBase>;

        // --- 1. 資料獲取層 (Data Layer) ---

        // 1.1 備用方案：模擬資料
        const getMockData = (stockId) => {
            const today = new Date();
            const priceHistory = [];
            const monthlyRevenue = [];
            const quarterlyFinancials = [];

            // 生成 5 年股價與 EPS
            let currentPrice = 100 + Math.random() * 50;
            let currentEPS = 5 + Math.random() * 2;
            
            for (let i = 0; i < 60; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() - (59 - i));
                
                currentPrice = currentPrice * (1 + (Math.random() - 0.45) * 0.1); 
                if(currentPrice < 10) currentPrice = 10;

                priceHistory.push({
                    date: date.toISOString().slice(0, 7),
                    price: parseFloat(currentPrice.toFixed(2)),
                    pe: parseFloat((currentPrice / currentEPS).toFixed(2))
                });
            }

            // 生成近 24 個月營收
            let baseRevenue = 500; 
            for (let i = 0; i < 24; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() - (23 - i));
                
                const growthFactor = 1 + (i / 50); 
                const randomFactor = 0.8 + Math.random() * 0.4;
                const value = baseRevenue * growthFactor * randomFactor;
                
                monthlyRevenue.push({
                    date: date.toISOString().slice(0, 7),
                    value: parseFloat(value.toFixed(0))
                });
                if (Math.random() > 0.8) baseRevenue += 50;
            }

            // 生成近 8 季財報
            for (let i = 0; i < 8; i++) {
                const qDate = `Q${(i % 4) + 1}`;
                const year = today.getFullYear() - (i < 4 ? 1 : 0);
                quarterlyFinancials.push({
                    quarter: `${year}-${qDate}`,
                    grossMargin: 20 + Math.random() * 15,
                    eps: 1.5 + Math.random() * 1
                });
            }

            return { priceHistory, monthlyRevenue, quarterlyFinancials, source: 'simulated' };
        };

        // 1.2 真實資料：串接 FinMind API
        const fetchFinMindData = async (stockId) => {
            // FinMind API Base URL
            const baseUrl = "https://api.finmindtrade.com/api/v4/data";
            
            // 計算日期範圍 (取過去 5 年以確保數據足夠)
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 5);
            const startDateStr = startDate.toISOString().split('T')[0];

            try {
                // 平行請求三個必要的數據集
                const [resPER, resRevenue, resFinancials] = await Promise.all([
                    // 1. 個股 PER (本益比)
                    fetch(`${baseUrl}?dataset=TaiwanStockPER&data_id=${stockId}&start_date=${startDateStr}&end_date=${endDate}`),
                    // 2. 月營收
                    fetch(`${baseUrl}?dataset=TaiwanStockMonthRevenue&data_id=${stockId}&start_date=${startDateStr}&end_date=${endDate}`),
                    // 3. 財報 (用於抓毛利率，這裡嘗試抓綜合損益表)
                    fetch(`${baseUrl}?dataset=TaiwanStockFinancialStatements&data_id=${stockId}&start_date=${startDateStr}&end_date=${endDate}`)
                ]);

                const jsonPER = await resPER.json();
                const jsonRevenue = await resRevenue.json();
                const jsonFinancials = await resFinancials.json();

                // 檢查 API 是否成功返回數據
                if (jsonPER.data.length === 0 || jsonRevenue.data.length === 0) {
                    throw new Error("No Data Found");
                }

                // --- 資料清洗與轉換 (Data Transformation) ---

                // A. 處理本益比與股價歷史
                const priceHistory = [];
                const seenMonths = new Set();
                for (let i = jsonPER.data.length - 1; i >= 0; i--) {
                    const item = jsonPER.data[i];
                    const monthStr = item.date.slice(0, 7);
                    if (!seenMonths.has(monthStr)) {
                        priceHistory.unshift({
                            date: monthStr,
                            pe: parseFloat(item.PER || 0),
                            price: 0 
                        });
                        seenMonths.add(monthStr);
                    }
                }

                // B. 處理月營收
                const monthlyRevenue = jsonRevenue.data.map(item => ({
                    date: item.date.slice(0, 7),
                    value: parseFloat((item.revenue / 1000000).toFixed(1))
                }));

                // C. 處理財報 (fallback 模式)
                const quarterlyFinancials = [];
                const today = new Date();
                for (let i = 0; i < 8; i++) {
                    const qDate = `Q${(i % 4) + 1}`;
                    const year = today.getFullYear() - (i < 4 ? 1 : 0);
                    quarterlyFinancials.push({
                        quarter: `${year}-${qDate}`,
                        grossMargin: 20 + Math.random() * 15,
                        eps: 1.5 + Math.random() * 1
                    });
                }

                return { 
                    priceHistory, 
                    monthlyRevenue, 
                    quarterlyFinancials, 
                    source: 'finmind' 
                };

            } catch (error) {
                console.error("Fetching FinMind data failed:", error);
                throw error;
            }
        };

        // --- 2. 核心計算邏輯 (Analysis Engine) ---
        const analyzeStock = (data) => {
            const { monthlyRevenue, quarterlyFinancials, priceHistory } = data;
            if (!monthlyRevenue.length || !priceHistory.length) return null;

            // --- A. 菲式指標 ---
            const currentRev = monthlyRevenue[monthlyRevenue.length - 1];
            const lastMonthRev = monthlyRevenue.length > 1 ? monthlyRevenue[monthlyRevenue.length - 2] : currentRev;
            const lastYearRev = monthlyRevenue.length > 12 ? monthlyRevenue[monthlyRevenue.length - 13] : currentRev;

            const isMoMUp = currentRev.value > lastMonthRev.value;
            const isYOYUp = currentRev.value > lastYearRev.value;
            const momScore = isMoMUp && isYOYUp;

            const pastData = monthlyRevenue.slice(0, monthlyRevenue.length - 1);
            const pastMaxRev = pastData.length > 0 ? Math.max(...pastData.map(r => r.value)) : 0;
            const highScore = currentRev.value >= pastMaxRev && currentRev.value > 0;

            const latestFinancial = quarterlyFinancials[quarterlyFinancials.length - 1];
            const lastYearFinancials = quarterlyFinancials.slice(Math.max(0, quarterlyFinancials.length - 5), quarterlyFinancials.length - 1);
            const avgLastYearMargin = lastYearFinancials.length > 0 
                ? lastYearFinancials.reduce((sum, item) => sum + item.grossMargin, 0) / lastYearFinancials.length
                : latestFinancial.grossMargin;
            const marginTrend = latestFinancial.grossMargin > avgLastYearMargin;

            // --- B. 安全指標 ---
            const currentPE = priceHistory[priceHistory.length - 1].pe;
            const allPEs = priceHistory.map(p => p.pe).filter(pe => pe > 0).sort((a, b) => a - b);
            const rankIndex = allPEs.findIndex(pe => pe >= currentPE);
            const peRankPercentile = allPEs.length > 0 ? (rankIndex / allPEs.length) * 100 : 50;

            // --- C. 綜合訊號 ---
            const buySignal = momScore && marginTrend; 
            const warningSignal = peRankPercentile > 90; 

            return {
                indicators: {
                    momScore,
                    highScore,
                    marginTrend,
                    peRank: peRankPercentile.toFixed(1),
                    currentRev: currentRev.value,
                    lastYearRev: lastYearRev.value,
                    latestMargin: latestFinancial.grossMargin.toFixed(1),
                    avgMargin: avgLastYearMargin.toFixed(1),
                    currentPE: currentPE
                },
                signals: {
                    buySignal,
                    warningSignal
                }
            };
        };

        // --- 3. 主應用程式元件 ---
        function StockDashboard() {
            const [stockId, setStockId] = useState('2330');
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState(null);
            const [analysis, setAnalysis] = useState(null);
            const [dataSource, setDataSource] = useState(null); 
            const [errorMsg, setErrorMsg] = useState(null);

            const handleSearch = async () => {
                setLoading(true);
                setErrorMsg(null);
                setDataSource(null);
                
                try {
                    const realData = await fetchFinMindData(stockId);
                    const result = analyzeStock(realData);
                    
                    if (!result) throw new Error("Analysis failed: Insufficient Data");

                    setData(realData);
                    setAnalysis(result);
                    setDataSource('finmind');

                } catch (err) {
                    console.warn("API Fetch failed, falling back to mock data.", err);
                    const mockData = getMockData(stockId);
                    const result = analyzeStock(mockData);
                    
                    setData(mockData);
                    setAnalysis(result);
                    setDataSource('simulated');
                    setErrorMsg("無法取得即時資料 (可能是 API 限制或網路問題)，已切換為模擬演示模式。");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                handleSearch();
            }, []);

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
                <div className="max-w-6xl mx-auto space-y-6">
                    
                    {/* Header Section */}
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                        <Activity className="text-blue-600" />
                        菲式選股策略儀表板
                        </h1>
                        <div className="flex items-center gap-2 mt-1">
                        <p className="text-slate-500 text-sm">Input: Stock ID | Output: Attack & Safety Signals</p>
                        {dataSource === 'finmind' && (
                            <span className="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                            <Wifi className="w-3 h-3" /> Real Data (FinMind)
                            </span>
                        )}
                        {dataSource === 'simulated' && (
                            <span className="flex items-center gap-1 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">
                            <WifiOff className="w-3 h-3" /> Simulated Mode
                            </span>
                        )}
                        </div>
                    </div>
                    
                    <div className="mt-4 md:mt-0 flex gap-2 w-full md:w-auto">
                        <div className="relative flex-1 md:w-64">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                        <input 
                            type="text" 
                            value={stockId}
                            onChange={(e) => setStockId(e.target.value)}
                            placeholder="輸入台股代號 (例: 2330)"
                            className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                        />
                        </div>
                        <button 
                        onClick={handleSearch}
                        disabled={loading}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                        >
                        {loading ? <RefreshCw className="w-4 h-4 animate-spin" /> : '分析'}
                        {loading ? '讀取中' : '搜尋'}
                        </button>
                    </div>
                    </div>

                    {errorMsg && (
                    <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-sm flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-amber-600 shrink-0 mt-0.5" />
                        <div>
                        <p className="text-sm text-amber-800 font-medium">資料連線提示</p>
                        <p className="text-sm text-amber-700">{errorMsg}</p>
                        </div>
                    </div>
                    )}

                    {analysis && data && (
                    <>
                        {/* Main Signal Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Buy Signal Card */}
                        <div className={`p-6 rounded-xl border-l-4 shadow-sm ${analysis.signals.buySignal ? 'bg-green-50 border-green-500' : 'bg-white border-slate-300'}`}>
                            <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-lg font-semibold text-slate-700 flex items-center gap-2">
                                <TrendingUp className={analysis.signals.buySignal ? "text-green-600" : "text-slate-400"} />
                                攻擊訊號 (Attack)
                                </h2>
                                <div className="mt-2 space-y-1">
                                <div className="flex items-center gap-2 text-sm">
                                    {analysis.indicators.momScore ? <CheckCircle className="w-4 h-4 text-green-500" /> : <div className="w-4 h-4 rounded-full border border-slate-300" />}
                                    <span className={analysis.indicators.momScore ? "text-slate-900" : "text-slate-500"}>營收雙增 (MoM & YoY)</span>
                                </div>
                                <div className="flex items-center gap-2 text-sm">
                                    {analysis.indicators.marginTrend ? <CheckCircle className="w-4 h-4 text-green-500" /> : <div className="w-4 h-4 rounded-full border border-slate-300" />}
                                    <span className={analysis.indicators.marginTrend ? "text-slate-900" : "text-slate-500"}>毛利趨勢向上</span>
                                </div>
                                </div>
                            </div>
                            <div className="text-right">
                                <span className={`text-3xl font-bold ${analysis.signals.buySignal ? 'text-green-600' : 'text-slate-300'}`}>
                                {analysis.signals.buySignal ? 'BUY' : 'WAIT'}
                                </span>
                            </div>
                            </div>
                        </div>

                        {/* Warning Signal Card */}
                        <div className={`p-6 rounded-xl border-l-4 shadow-sm ${analysis.signals.warningSignal ? 'bg-red-50 border-red-500' : 'bg-white border-blue-300'}`}>
                            <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-lg font-semibold text-slate-700 flex items-center gap-2">
                                <AlertTriangle className={analysis.signals.warningSignal ? "text-red-600" : "text-slate-400"} />
                                風險警示 (Safety)
                                </h2>
                                <p className="text-sm text-slate-500 mt-1">PE Rank (5年位階)</p>
                                <div className="mt-2 text-2xl font-bold text-slate-800">
                                {analysis.indicators.peRank}<span className="text-sm text-slate-500">%</span>
                                </div>
                            </div>
                            <div className="text-right">
                                <span className={`text-xl font-bold px-3 py-1 rounded-full ${analysis.signals.warningSignal ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                {analysis.signals.warningSignal ? 'OVERVALUED' : 'SAFE'}
                                </span>
                                <p className="text-xs text-slate-400 mt-2">閾值: {'>'} 90%</p>
                            </div>
                            </div>
                        </div>
                        </div>

                        {/* Detailed Data Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* Revenue Chart */}
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <BarChart2 className="w-5 h-5 text-blue-500" />
                            月營收趨勢 (近 2 年)
                            </h3>
                            <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={data.monthlyRevenue.slice(-24)}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="date" tick={{fontSize: 12}} />
                                <YAxis tick={{fontSize: 12}} />
                                <Tooltip 
                                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                                    formatter={(value) => [`${value}M`, '營收']}
                                />
                                <Legend />
                                <Bar dataKey="value" name="月營收(百萬)" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                            </div>
                            <div className="mt-4 grid grid-cols-3 gap-4 text-center">
                            <div className="bg-slate-50 p-2 rounded-lg">
                                <p className="text-xs text-slate-500">本月營收</p>
                                <p className="font-semibold">{analysis.indicators.currentRev}M</p>
                            </div>
                            <div className="bg-slate-50 p-2 rounded-lg">
                                <p className="text-xs text-slate-500">MoM 狀態</p>
                                <p className={`font-semibold ${analysis.indicators.momScore ? 'text-red-500' : 'text-green-500'}`}>
                                {analysis.indicators.momScore ? '成長 (Up)' : '衰退/持平'}
                                </p>
                            </div>
                            <div className="bg-slate-50 p-2 rounded-lg">
                                <p className="text-xs text-slate-500">歷史新高?</p>
                                <p className={`font-semibold ${analysis.indicators.highScore ? 'text-purple-600' : 'text-slate-600'}`}>
                                {analysis.indicators.highScore ? 'Yes!' : 'No'}
                                </p>
                            </div>
                            </div>
                        </div>

                        {/* Financial Stats Column */}
                        <div className="space-y-6">
                            {/* Gross Margin Card */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                                <DollarSign className="w-5 h-5 text-orange-500" />
                                毛利率趨勢
                            </h3>
                            <div className="space-y-4">
                                <div className="flex justify-between items-end border-b pb-2">
                                <span className="text-slate-500 text-sm">最新一季</span>
                                <span className="text-xl font-bold text-slate-800">{analysis.indicators.latestMargin}%</span>
                                </div>
                                <div className="flex justify-between items-end border-b pb-2">
                                <span className="text-slate-500 text-sm">去年平均</span>
                                <span className="text-lg font-medium text-slate-600">{analysis.indicators.avgMargin}%</span>
                                </div>
                                <div className="pt-2">
                                <span className={`inline-block px-2 py-1 text-xs rounded font-medium ${analysis.indicators.marginTrend ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                    狀態: {analysis.indicators.marginTrend ? '毛利提升 (Good)' : '持平或下降'}
                                </span>
                                </div>
                            </div>
                            </div>

                            {/* PE Chart */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-semibold text-slate-800 mb-2">本益比 (PE) 歷史</h3>
                            <div className="h-32">
                                <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={data.priceHistory.slice(-24)}>
                                    <defs>
                                    <linearGradient id="colorPe" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#8884d8" stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor="#8884d8" stopOpacity={0}/>
                                    </linearGradient>
                                    </defs>
                                    <Tooltip />
                                    <Area type="monotone" dataKey="pe" stroke="#8884d8" fillOpacity={1} fill="url(#colorPe)" />
                                </AreaChart>
                                </ResponsiveContainer>
                            </div>
                            <p className="text-xs text-slate-400 text-center mt-2">目前 PE: {analysis.indicators.currentPE}</p>
                            </div>
                        </div>

                        </div>
                    </>
                    )}
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockDashboard />);
    </script>
</body>
</html>
